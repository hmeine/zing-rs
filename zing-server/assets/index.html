<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/quasar@2.11.3/dist/quasar.prod.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <title>Zing</title>
  </head>

  <body>
    <div id="q-app">
      <q-form autofocus="true" @submit="login" v-if="!loggedin">
        <q-input label="Name" v-model="loginname"></q-input>
        <q-btn color="primary" label="Login" type="submit"></q-btn>
      </q-form>
      <q-form autofocus="true" @submit="logout" v-else>
        <q-btn color="primary" :label="logoutCaption" type="submit"></q-btn>
      </q-form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2.11.3/dist/quasar.umd.prod.js"></script>

    <script>
      const { ref, computed, createApp } = Vue;

      const loginname = ref("");
      const username = ref("");

      const loggedin = computed(() => username.value.length > 0);

      const logoutCaption = computed(() => "Logout '" + username.value + "'");

      function login() {
        axios
          .post("/login", {
            name: loginname.value,
          })
          .then(function (response) {
            username.value = loginname.value;
          })
          .catch(function (error) {
            console.log(error);
          });
        return false;
      }

      function logout() {
        axios
          .delete("/login")
          .then(function (response) {
            username.value = "";
          })
          .catch(function (error) {
            if (error.response.status == 401) {
              // illegal login cookie -> just clear username
              username.value = "";
            } else {
              console.log(error);
            }
          });
        return false;
      }

      const app = createApp({
        setup() {
          return {
            loginname,
            username,
            loggedin,
            logoutCaption,
            login,
            logout,
          };
        },

        mounted() {
          axios
            .get("/login")
            .then((response) => {
              username.value = response.data;
              loginname.value = response.data;
            })
            .catch(function (error) {
              // we do not have to log "not logged in" errors
              if (error.response.status != 401) {
                console.log(error);
              }
            });
        },
      });

      app.use(Quasar);
      app.mount("#q-app");
    </script>
  </body>
</html>
